<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Assembly Station | Restaurant Order Management</title><link rel="stylesheet" href="styles.css"><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script>let supabaseJs=supabase</script><style>.orders-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;padding:16px}.order-tile{background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:16px;display:flex;flex-direction:column;position:relative;min-height:200px;transition:all .3s ease}.order-tile.pending{border-left:5px solid #3498db}.order-tile.in-progress{border-left:5px solid #f39c12;background-color:#fffcf5}.order-tile.done{border-left:5px solid #2ecc71;background-color:#f5fff7}.order-header{display:flex;justify-content:space-between;margin-bottom:8px}.order-info{font-weight:700}.order-time{color:#7f8c8d;font-size:.9em}.order-items{flex-grow:1;margin:10px 0}.order-item{display:flex;justify-content:space-between;margin:5px 0;padding:5px 0;border-bottom:1px dashed #eee}.order-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}.btn{border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:700;transition:background-color .2s}.btn-assign{background-color:#3498db;color:#fff}.btn-assign:hover{background-color:#2980b9}.btn-done{background-color:#2ecc71;color:#fff}.btn-done:hover{background-color:#27ae60}.status-badge{position:absolute;top:8px;right:8px;padding:4px 8px;border-radius:12px;font-size:.8em;font-weight:700;text-transform:uppercase}.status-pending{background-color:#e3f2fd;color:#1565c0}.status-in-progress{background-color:#fff3e0;color:#e65100}.status-done{background-color:#e8f5e9;color:#2e7d32}.assigned-to{font-size:.9em;font-style:italic;margin-top:5px;color:#7f8c8d}.toggle-container{display:flex;justify-content:flex-end;padding:8px 16px;align-items:center}.toggle-history{display:flex;align-items:center;cursor:pointer;user-select:none}.toggle-switch{position:relative;display:inline-block;width:40px;height:20px;margin-right:8px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;border-radius:34px;transition:.3s}.toggle-slider:before{position:absolute;content:"";height:16px;width:16px;left:2px;bottom:2px;background-color:#fff;border-radius:50%;transition:.3s}input:checked+.toggle-slider{background-color:#2ecc71}input:checked+.toggle-slider:before{transform:translateX(20px)}.history-container{display:none;margin:0 16px 16px;border-radius:8px;background-color:#f9f9f9;border:1px solid #ddd;max-height:250px;overflow-y:auto}.history-container.visible{display:block}.history-list{list-style:none;padding:0;margin:0}.history-item{padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center}.history-item:last-child{border-bottom:none}.history-item:hover{background-color:#f0f0f0}.history-details{display:none;background-color:#fff;padding:8px;margin-top:4px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.history-item.expanded .history-details{display:block}.history-badge{font-size:.8em;padding:2px 6px;border-radius:12px;background-color:#e8f5e9;color:#2e7d32}.station-header{display:flex;align-items:center;margin-top:10px;margin-bottom:5px;font-weight:700}.station-header::before{content:'';display:inline-block;width:10px;height:10px;margin-right:5px;border-radius:50%}.station-header:first-child{margin-top:0}.station-header[data-station=assembly]::before{background-color:#2196f3}.station-header[data-station=grill]::before{background-color:#f44336}.station-header[data-station=fries]::before{background-color:#ff9800}.station-header[data-station=kitchen]::before{background-color:#4caf50}</style></head><body><div class="container"><header><div class="logo">Restaurant Order Management</div><div class="station-header"><div class="station-name">Assembly Station</div><div class="clock" id="clock"></div></div></header><main><div class="toggle-container"><label class="toggle-history"><span class="toggle-switch"><input type="checkbox" id="historyToggle"> <span class="toggle-slider"></span> </span>Show Completed Orders</label></div><div id="history-container" class="history-container"><ul id="history-list" class="history-list"><li class="history-item"><span>Loading history...</span></li></ul></div><div id="orders-grid" class="orders-grid"><div class="order-tile pending"><div class="status-badge status-pending">Loading...</div><div class="order-header"><div class="order-info">Loading orders...</div><div class="order-time">-</div></div></div></div></main></div><script src="supabase-client.js"></script><script>let clockElement=document.getElementById("clock"),ordersGridElement=document.getElementById("orders-grid"),historyToggle=document.getElementById("historyToggle"),historyContainer=document.getElementById("history-container"),historyList=document.getElementById("history-list"),EMPLOYEE_NAME="Employee1",historyLoaded=!1;function updateClock(){var e=new Date;clockElement.textContent=e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}async function loadInitialData(){try{console.log("Fetching assembly data...");var e="http://localhost:3000/stations/assembly?t="+(new Date).getTime(),t=(console.log("Fetching from URL:",e),await fetch(e,{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}}));if(!t.ok)throw console.error("Server returned error:",t.status,t.statusText),new Error("Failed to fetch assembly data");let r=await t.json();console.log(`Received ${r.length} orders:`,r),ordersGridElement.innerHTML="",0===r.length?ordersGridElement.innerHTML=`
            <div class="info-message" style="text-align: center; padding: 20px; color: #666;">
              No pending orders for assembly at this time.
            </div>
          `:(console.log("Rendering orders to UI..."),r.forEach((e,t)=>{console.log(`Rendering order ${t+1}/${r.length}:`,e.id),renderOrderTile(e)}),console.log("Finished rendering orders"))}catch(e){console.error("Error loading assembly data:",e),ordersGridElement.innerHTML=`
          <div class="error-message">
            Failed to load orders. Please try refreshing the page.
          </div>
        `}}function renderOrderTile(r){var e=new Date(r.scheduled_at||r.order_time),t=r.status.replace("_","-"),s=`#${r.order_number} - `+(r.customer||"No customer"),o=document.createElement("div");o.className="order-tile "+t,o.id="order-"+r.id;let a=`
        <div class="status-badge status-${t}">${r.status.replace("_"," ")}</div>
        <div class="order-header">
          <div class="order-info">${s}</div>
          <div class="order-time">${formatTime(e)}</div>
        </div>`;return r.order_prep_status&&(t=r.order_prep_status.toLowerCase().replace(/\s+/g,"-"),a+=`
          <div class="prep-status-indicator ${t}">
            ${r.order_prep_status}
          </div>`),a+='<div class="order-items">',r.groupedItems?Object.keys(r.groupedItems).sort((e,t)=>"assembly"===e?-1:"assembly"===t?1:e.localeCompare(t)).forEach(e=>{var t=r.groupedItems[e];t&&0!==t.length&&(a+=`
            <div class="station-header" data-station="${e}">
              ${e.charAt(0).toUpperCase()+e.slice(1)}
            </div>
            <div class="station-items">`,t.forEach(e=>{var t=e.prep_status?e.prep_status.toLowerCase().replace(/\s+/g,"-"):"";a+=`
              <div class="order-item ${t}">
                <div class="item-name">${e.item_name}</div>
                <div class="item-quantity">x${e.quantity}</div>`,e.prep_status&&(a+=`<div class="item-prep-status">${e.prep_status}</div>`),0<e.preparation_time_minutes&&(a+=`<div class="item-prep-time">${e.preparation_time_minutes} min prep</div>`),a+="</div>"}),a+="</div>")}):(r.items||[]).forEach(e=>{var t=e.prep_status?e.prep_status.toLowerCase().replace(/\s+/g,"-"):"";a+=`
            <div class="order-item ${t}">
              <div class="item-name">${e.item_name}</div>
              <div class="item-quantity">x${e.quantity}</div>`,e.prep_status&&(a+=`<div class="item-prep-status">${e.prep_status}</div>`),0<e.preparation_time_minutes&&(a+=`<div class="item-prep-time">${e.preparation_time_minutes} min prep</div>`),a+="</div>"}),a=(a+="</div>")+`
        <div class="order-actions">
          ${"pending"===r.status?`<button class="assign-button" onclick="assignOrder(${r.id})">Assign to me</button>`:""}
          ${"in_progress"===r.status?`<button class="done-button" onclick="markAsDone(${r.id})">Mark as Done</button>`:""}
        </div>`,o.innerHTML=a,ordersGridElement.appendChild(o),o}async function updateOrderStatus(e,t,r){try{console.log(`Starting update for order ${e} - Status: ${t}, Assigned to: `+r);var s,o=await fetch("http://localhost:3000/orders/"+e,{method:"PUT",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({status:t,assigned_to:r})});if(console.log("Response status: "+o.status),!o.ok)throw s=await o.json().catch(()=>({})),console.error("Server returned error:",s),new Error(`Failed to update order status: ${o.status} `+o.statusText);setTimeout(()=>{window.location.reload()},500)}catch(e){console.error("Error updating order status:",e),alert("Failed to update order status. Please try again.")}}function subscribeToOrders(){return supabase.channel("public:orders").on("postgres_changes",{event:"*",schema:"public",table:"orders"},handleOrderChange).subscribe()}function handleOrderChange(e){var t=e.new;"INSERT"!==e.eventType&&"UPDATE"!==e.eventType||fetchOrderWithItems(t.id),"DELETE"===e.eventType&&(e=document.getElementById("order-"+t.id))&&e.remove()}async function fetchOrderWithItems(e){try{var t=await fetch("http://localhost:3000/orders/"+e);if(!t.ok)throw new Error("Failed to fetch order details");var r,s,o=await t.json();"done"===o.status?(r=document.getElementById("order-"+o.id))&&r.remove():((s=document.getElementById("order-"+o.id))&&s.remove(),renderOrderTile(o))}catch(e){console.error("Error fetching order details:",e)}}function loadCompletedOrders(){var e=document.getElementById("historyTimeframe"),e=e?e.value:"day";fetchWithAuth(API_URL+"/stations/assembly/history?timeframe="+e).then(e=>e.json()).then(e=>{let t=document.getElementById("historyContainer");t.innerHTML="",0===e.length?t.innerHTML="<p>No completed orders found for this period.</p>":e.forEach(r=>{var e=document.createElement("div");e.className="history-order";let s=`
              <div class="history-order-header" onclick="toggleOrderDetails(this)">
                <span class="order-number">#${r.order_number}</span>
                <span class="order-customer">${r.customer||"No customer"}</span>
                <span class="order-time">${new Date(r.order_time).toLocaleString()}</span>
                <span class="toggle-icon">▼</span>
              </div>
              <div class="history-order-details">`;r.groupedItems?Object.keys(r.groupedItems).sort((e,t)=>"assembly"===e?-1:"assembly"===t?1:e.localeCompare(t)).forEach(e=>{var t=r.groupedItems[e];s+=`
                  <div class="station-header" data-station="${e}">
                    ${e.charAt(0).toUpperCase()+e.slice(1)}
                  </div>
                  <div class="station-items">`,t.forEach(e=>{s+=`
                    <div class="order-item">
                      <div class="item-name">${e.item_name}</div>
                      <div class="item-quantity">x${e.quantity}</div>`,0<e.preparation_time_minutes&&(s+=`<div class="item-prep-time">${e.preparation_time_minutes} min prep</div>`),s+="</div>"}),s+="</div>"}):(s+="<ul>",r.items.forEach(e=>{s+=`
                  <li>
                    ${e.item_name} x${e.quantity}
                    ${0<e.preparation_time_minutes?`<span class="item-prep-time">(${e.preparation_time_minutes} min prep)</span>`:""}
                  </li>`}),s+="</ul>"),s+="</div>",e.innerHTML=s,t.appendChild(e)})}).catch(e=>{console.error("Error loading completed orders:",e),document.getElementById("historyContainer").innerHTML="<p>Error loading completed orders.</p>"})}async function assignOrder(e){console.log(`Assigning order ${e} to `+EMPLOYEE_NAME);try{var t=await fetch("http://localhost:3000/stations/assembly/order/"+e,{method:"PUT",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({status:"in_progress",assigned_to:EMPLOYEE_NAME})});if(!t.ok)throw new Error("Failed to assign order: "+t.status);console.log("Order assigned successfully"),setTimeout(()=>{window.location.reload()},500)}catch(e){console.error("Error assigning order:",e),alert("Failed to assign order. Please try again.")}}async function markAsDone(e){console.log(`Marking order ${e} as done`);try{var t=await fetch("http://localhost:3000/stations/assembly/order/"+e,{method:"PUT",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},body:JSON.stringify({status:"done",assigned_to:null})});if(!t.ok)throw new Error("Failed to mark order as done: "+t.status);console.log("Order marked as done successfully"),setTimeout(()=>{window.location.reload()},500)}catch(e){console.error("Error marking order as done:",e),alert("Failed to mark order as done. Please try again.")}}updateClock(),setInterval(updateClock,1e3),historyToggle.addEventListener("change",function(){this.checked?(historyContainer.classList.add("visible"),loadCompletedOrders()):historyContainer.classList.remove("visible")}),document.addEventListener("DOMContentLoaded",()=>{loadInitialData(),subscribeToOrders()})</script></body></html>