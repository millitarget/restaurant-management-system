<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Manager</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- API Config for environment-aware endpoints -->
  <script src="api-config.js"></script>
  <script src="supabase-client.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      color: #333;
      height: 100vh;
      overflow-y: auto;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }
    
    .manager {
      background: linear-gradient(135deg, #673AB7, #9C27B0);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .manager h1 {
      margin: 0;
      font-size: 28px;
    }
    
    .nav-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      gap: 5px;
    }
    
    .nav-tab {
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-bottom: none;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .nav-tab:hover {
      background-color: #e9e9e9;
      transform: translateY(-3px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .nav-tab.active {
      background-color: #673AB7;
      color: white;
      border-color: #673AB7;
      box-shadow: 0 2px 8px rgba(103, 58, 183, 0.3);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
      overflow-y: auto;
      flex: 1;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .orders-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      overflow-y: auto;
      max-height: calc(100vh - 180px);
    }
    
    .time-slots, .cashier-orders {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-y: auto;
      max-height: calc(100vh - 180px);
    }
    
    .section-header {
      font-size: 18px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f1f1;
      color: #673AB7;
      font-weight: 600;
    }
    
    .time-slot {
      margin-bottom: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .time-slot-header {
      background-color: #f8f9fa;
      padding: 10px 15px;
      font-weight: 600;
      border-bottom: 1px solid #eee;
      color: #673AB7;
    }
    
    .slot-orders, .cashier-orders {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }
    
    .order-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .order-id {
      font-weight: 600;
      color: #673AB7;
    }
    
    .order-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-pending {
      background-color: #FFC107;
      color: #333;
    }
    
    .status-in-progress {
      background-color: #2196F3;
      color: white;
    }
    
    .status-done {
      background-color: #4CAF50;
      color: white;
    }
    
    .order-details {
      margin-bottom: 10px;
    }
    
    .order-customer {
      font-weight: 500;
    }
    
    .order-source {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .order-time {
      font-size: 12px;
      color: #666;
    }
    
    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: #673AB7;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #5E35B1;
      box-shadow: 0 2px 5px rgba(103, 58, 183, 0.3);
    }
    
    .btn-success {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #43A047;
      box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
    }
    
    .btn-danger {
      background-color: #F44336;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #E53935;
      box-shadow: 0 2px 5px rgba(244, 67, 54, 0.3);
    }
    
    .no-orders {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
      background-color: #f9f9f9;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    #order-form {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: #673AB7;
      box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.2);
      outline: none;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .error {
      background-color: #FFEBEE;
      color: #D32F2F;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 500;
    }
    
    @media (max-width: 768px) {
      .orders-container {
        grid-template-columns: 1fr;
      }
      
      .nav-tabs {
        flex-wrap: wrap;
      }
      
      .nav-tab {
        flex: 1 0 auto;
        text-align: center;
      }
    }
    
    /* Order Details Styles */
    #order-details-container {
      overflow-y: auto;
      max-height: calc(100vh - 180px);
    }
    
    .order-detail-card {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f1f1;
    }
    
    .detail-header h2 {
      margin: 0;
      color: #673AB7;
      font-size: 24px;
    }
    
    .detail-info {
      margin-bottom: 25px;
    }
    
    .info-row {
      display: flex;
      margin-bottom: 10px;
    }
    
    .info-label {
      width: 100px;
      font-weight: 600;
      color: #555;
    }
    
    .info-value {
      flex: 1;
    }
    
    .detail-items {
      margin-bottom: 25px;
    }
    
    .detail-items h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #673AB7;
      font-size: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f1f1f1;
    }
    
    .items-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #673AB7;
    }
    
    .item-name {
      flex: 1;
      font-weight: 500;
    }
    
    .item-quantity {
      width: 50px;
      text-align: center;
      font-weight: 600;
      color: #673AB7;
    }
    
    .item-station {
      width: 100px;
      text-align: center;
      background-color: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .item-status {
      width: 100px;
      text-align: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 10px;
    }
    
    .detail-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .no-items {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    
    #new-content {
      overflow-y: auto;
    }
    
    #order-form-container {
      overflow-y: auto;
      max-height: calc(100vh - 180px);
    }
    
    #order-form {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .order-filters {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .filter-header {
      font-weight: 600;
      margin-bottom: 10px;
      color: #673AB7;
    }
    
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 50px;
      background-color: #f1f1f1;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .filter-btn:hover {
      background-color: #e9e9e9;
      transform: translateY(-2px);
    }
    
    .filter-btn.active {
      background-color: #673AB7;
      color: white;
      border-color: #673AB7;
      box-shadow: 0 2px 5px rgba(103, 58, 183, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="manager">
      <h1>Restaurant Order Management</h1>
      <button id="create-order-btn" class="btn btn-primary">Create New Order</button>
    </div>
    
    <div class="nav-tabs">
      <div class="nav-tab active" id="orders-tab">Orders</div>
      <div class="nav-tab" id="details-tab">Order Details</div>
      <div class="nav-tab" id="new-tab">New Order</div>
    </div>
    
    <div class="tab-content active" id="orders-content">
      <div class="order-filters">
        <div class="filter-header">Filter by Time:</div>
        <div id="time-filters" class="filter-buttons">
          <button class="filter-btn active" data-filter="all">All Orders</button>
          <!-- Time filter buttons will be added here dynamically -->
        </div>
      </div>
      <div class="orders-container">
        <div class="time-slots">
          <div class="section-header">Scheduled Orders</div>
          <div id="time-slots-container"></div>
        </div>
        <div class="cashier-orders">
          <div class="section-header">Walk-in & Unscheduled Orders</div>
          <div id="cashier-orders-container"></div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="details-content">
      <div id="order-details-container">
        <div class="no-orders">Select an order to view details</div>
      </div>
    </div>
    
    <div class="tab-content" id="new-content">
      <div id="order-form-container" style="display: none;">
        <div id="order-form" class="order-form">
          <h2 id="form-title">Create New Order</h2>
          <input type="hidden" id="order-id">

          <div class="form-group">
            <label for="customer">Customer Name:</label>
            <input type="text" id="customer" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="source">Order Source:</label>
            <select id="source" class="form-control">
              <option value="walk-in">Walk-in</option>
              <option value="phone">Phone</option>
              <option value="online">Online</option>
            </select>
          </div>

          <div class="form-group">
            <label for="scheduled-time">Scheduled Time:</label>
            <input type="datetime-local" id="scheduled-time" class="form-control">
          </div>

          <div class="form-group">
            <label for="status">Status:</label>
            <select id="status" class="form-control">
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="items-container">
            <h3>Order Items</h3>
            
            <div class="item-row item-header">
              <div>Item Name</div>
              <div>Quantity</div>
              <div>Station</div>
              <div>Prep Time</div>
              <div>Status</div>
              <div>Action</div>
            </div>
            
            <div id="items-list">
              <!-- Items will be added here dynamically -->
            </div>
            
            <button id="add-item" class="btn-add-item">+ Add Item</button>
          </div>
          
          <div class="form-actions">
            <button id="save-order" class="btn-save">Save Order</button>
            <button id="cancel-edit" class="btn-cancel" style="margin-left: 10px;">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Template for item row -->
  <template id="item-template">
    <div class="item-row" data-item-id="">
      <input type="text" class="form-control item-name" placeholder="Item name">
      <input type="number" class="form-control item-quantity" min="1" value="1">
      <select class="station-select">
        <option value="grill">Grill</option>
        <option value="kitchen">Kitchen</option>
        <option value="fries">Fries</option>
        <option value="assembly">Assembly</option>
      </select>
      <input type="number" class="form-control prep-time" min="0" value="15" placeholder="Minutes">
      <select class="item-status-select">
        <option value="pending">Pending</option>
        <option value="in_progress">In Progress</option>
        <option value="done">Done</option>
      </select>
      <button class="btn-remove-item">Remove</button>
    </div>
  </template>
  
  <script>
    // DOM elements
    const orderForm = document.getElementById('order-form');
    const orderFormContainer = document.getElementById('order-form-container');
    const formTitle = document.getElementById('form-title');
    const orderIdInput = document.getElementById('order-id');
    const addItemButton = document.getElementById('add-item');
    const saveOrderButton = document.getElementById('save-order');
    const cancelEditButton = document.getElementById('cancel-edit');
    const createOrderBtn = document.getElementById('create-order-btn');
    const itemsList = document.getElementById('items-list');
    const timeSlotsContainer = document.getElementById('time-slots-container');
    const cashierOrdersContainer = document.getElementById('cashier-orders-container');
    const itemTemplate = document.getElementById('item-template');
    const orderTabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const timeFiltersContainer = document.getElementById('time-filters');
    
    // Current active filter
    let activeFilter = 'all';
    let allOrders = []; // Store all orders for filtering
    
    // Load saved filter from localStorage if it exists
    const savedFilter = localStorage.getItem('orderManagerActiveFilter');
    if (savedFilter) {
      activeFilter = savedFilter;
    }
    
    // Tab navigation
    orderTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        orderTabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const contentId = tab.id.replace('-tab', '-content');
        document.getElementById(contentId).classList.add('active');
        
        // If new order tab is clicked, show the order form
        if (tab.id === 'new-tab') {
          orderFormContainer.style.display = 'block';
        } else {
          orderFormContainer.style.display = 'none';
        }
      });
    });
    
    // Create New Order button
    document.getElementById('create-order-btn').addEventListener('click', () => {
      // Clear the form
      orderForm.reset();
      
      // Show the new order tab
      orderTabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      document.getElementById('new-tab').classList.add('active');
      document.getElementById('new-content').classList.add('active');
      
      // Show the order form
      orderFormContainer.style.display = 'block';
      
      // Focus on the first input
      document.querySelector('#order-form input').focus();
    });
    
    // Add item functionality
    function addItemRow(item = {}) {
      const newItem = document.importNode(itemTemplate.content, true);
      const itemRow = newItem.querySelector('.item-row');
      
      // Set values if item is provided
      if (item.id) {
        itemRow.dataset.itemId = item.id;
      }
      
      if (item.item_name) {
        newItem.querySelector('.item-name').value = item.item_name;
      }
      
      if (item.quantity) {
        newItem.querySelector('.item-quantity').value = item.quantity;
      }
      
      if (item.station) {
        newItem.querySelector('.station-select').value = item.station;
      }
      
      if (item.preparation_time_minutes) {
        newItem.querySelector('.prep-time').value = item.preparation_time_minutes;
      }
      
      if (item.item_status) {
        newItem.querySelector('.item-status-select').value = item.item_status;
      }
      
      // Add remove button functionality
      newItem.querySelector('.btn-remove-item').addEventListener('click', function() {
        itemRow.remove();
      });
      
      itemsList.appendChild(newItem);
    }
    
    // Add item button click
    addItemButton.addEventListener('click', function() {
      addItemRow();
    });
    
    // Load orders
    async function loadAllOrders() {
      try {
        console.log('Loading all orders...');
        document.getElementById('time-slots-container').innerHTML = '<div class="loading">Loading orders...</div>';
        document.getElementById('cashier-orders-container').innerHTML = '<div class="loading">Loading orders...</div>';
        
        // Use API_CONFIG to get the appropriate URL for the environment
        const apiUrl = API_CONFIG.getUrl('/orders');
        console.log('Fetching orders from:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
        }
        
        const orders = await response.json();
        console.log('Orders received:', orders);
        allOrders = orders; // Store all orders for filtering
        
        // Generate time filter buttons first (this will set up all the filters)
        generateTimeFilters(orders);
        
        // If we have an active filter that's not 'all', we'll apply it in the generateTimeFilters function
        // Otherwise, just display all orders
        if (activeFilter === 'all') {
          displayOrders(orders);
        }
        
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('time-slots-container').innerHTML = `<div class="error">Error loading orders: ${error.message}</div>`;
        document.getElementById('cashier-orders-container').innerHTML = `<div class="error">Error loading orders: ${error.message}</div>`;
      }
    }
    
    // Generate time filter buttons
    function generateTimeFilters(orders) {
      // Clear existing filters except "All Orders"
      const allFilter = timeFiltersContainer.querySelector('[data-filter="all"]');
      timeFiltersContainer.innerHTML = '';
      timeFiltersContainer.appendChild(allFilter);
      
      // Get unique time slots from orders
      const timeSlots = new Set();
      
      orders.forEach(order => {
        if (order.scheduled_at) {
          const scheduledTime = new Date(order.scheduled_at);
          const roundedMinutes = Math.round(scheduledTime.getMinutes() / 15) * 15;
          scheduledTime.setMinutes(roundedMinutes);
          scheduledTime.setSeconds(0);
          
          const timeSlotKey = scheduledTime.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          
          timeSlots.add(timeSlotKey);
        }
      });
      
      // Add "Now" filter for walk-in and unscheduled orders
      if (orders.some(order => order.source === 'walk-in' || !order.scheduled_at)) {
        const nowButton = document.createElement('button');
        nowButton.className = 'filter-btn';
        nowButton.textContent = 'ASAP / Now';
        nowButton.dataset.filter = 'now';
        nowButton.addEventListener('click', () => filterOrders('now'));
        timeFiltersContainer.appendChild(nowButton);
      }
      
      // Sort time slots chronologically
      const sortedTimeSlots = Array.from(timeSlots).sort((a, b) => {
        return new Date('1970/01/01 ' + a) - new Date('1970/01/01 ' + b);
      });
      
      // Create filter button for each time slot
      sortedTimeSlots.forEach(timeSlot => {
        const button = document.createElement('button');
        button.className = 'filter-btn';
        button.textContent = timeSlot;
        button.dataset.filter = timeSlot;
        button.addEventListener('click', () => filterOrders(timeSlot));
        timeFiltersContainer.appendChild(button);
      });
      
      // Add event listener to All Orders button
      allFilter.addEventListener('click', () => filterOrders('all'));
      
      // Apply saved filter if it exists
      if (activeFilter !== 'all') {
        // Check if the filter button exists for the saved filter
        const filterExists = Array.from(timeFiltersContainer.querySelectorAll('.filter-btn')).some(
          btn => btn.dataset.filter === activeFilter
        );
        
        if (filterExists) {
          // Apply the saved filter
          filterOrders(activeFilter);
        } else {
          // Reset to all if the saved filter doesn't exist anymore
          activeFilter = 'all';
          localStorage.setItem('orderManagerActiveFilter', 'all');
          filterOrders('all');
        }
      } else {
        // Make sure the All button is active
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === 'all');
        });
      }
    }
    
    // Filter orders by time
    function filterOrders(filterValue) {
      // Update active filter
      activeFilter = filterValue;
      
      // Save filter to localStorage
      localStorage.setItem('orderManagerActiveFilter', filterValue);
      
      // Update filter button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filterValue);
      });
      
      // Filter orders based on selected time
      if (filterValue === 'all') {
        displayOrders(allOrders);
      } else if (filterValue === 'now') {
        // Filter for walk-in and unscheduled orders
        const filteredOrders = allOrders.filter(order => 
          order.source === 'walk-in' || 
          ((order.source === 'phone' || order.source === 'online') && !order.scheduled_at)
        );
        displayOrders(filteredOrders);
      } else {
        // Filter by specific time slot
        const filteredOrders = allOrders.filter(order => {
          if (!order.scheduled_at) return false;
          
          const scheduledTime = new Date(order.scheduled_at);
          const roundedMinutes = Math.round(scheduledTime.getMinutes() / 15) * 15;
          scheduledTime.setMinutes(roundedMinutes);
          scheduledTime.setSeconds(0);
          
          const timeSlotKey = scheduledTime.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          
          return timeSlotKey === filterValue;
        });
        displayOrders(filteredOrders);
      }
    }
    
    // Display orders in the UI
    function displayOrders(orders) {
      if (!orders || !Array.isArray(orders)) {
        console.error('Invalid orders data received:', orders);
        document.getElementById('time-slots-container').innerHTML = '<div class="error">Error: Invalid data format received from server</div>';
        document.getElementById('cashier-orders-container').innerHTML = '<div class="error">Error: Invalid data format received from server</div>';
        return;
      }
      
      console.log('Displaying orders:', orders.length, 'orders found');
      
      try {
        // Get the containers from our new layout
        const timeSlotContainer = document.getElementById('time-slots-container');
        const cashierOrdersContainer = document.getElementById('cashier-orders-container');
        
        // Organize and display orders with our updated organizeOrders function
        organizeOrders(orders, timeSlotContainer, cashierOrdersContainer);
      } catch (error) {
        console.error('Error displaying orders:', error);
        document.getElementById('time-slots-container').innerHTML = `<div class="error">Error displaying orders: ${error.message}</div>`;
        document.getElementById('cashier-orders-container').innerHTML = `<div class="error">Error displaying orders: ${error.message}</div>`;
      }
    }
    
    // Organize orders into time slots and cashier orders
    function organizeOrders(orders, timeSlotsContainer, cashierOrdersContainer) {
      // Clear containers
      timeSlotsContainer.innerHTML = '';
      cashierOrdersContainer.innerHTML = '';
      
      if (!orders || orders.length === 0) {
        console.log('No orders to organize');
        timeSlotsContainer.innerHTML = '<div class="no-orders">No scheduled orders</div>';
        cashierOrdersContainer.innerHTML = '<div class="no-orders">No walk-in orders</div>';
        return;
      }
      
      console.log(`Organizing ${orders.length} orders`);
      
      // Initialize time slots and cashier orders
      const timeSlots = {};
      const cashierOrders = [];
      
      // Process each order
      orders.forEach(order => {
        // Check if it's a walk-in order or a phone/online order without scheduled time
        if (order.source === 'walk-in' || 
            ((order.source === 'phone' || order.source === 'online') && !order.scheduled_at)) {
          console.log(`Adding ${order.source} order to cashier orders: ${order.id}`);
          cashierOrders.push(order);
        } else if (order.scheduled_at) {
          // Get the scheduled time and round to nearest 15 minutes for grouping
          const scheduledTime = new Date(order.scheduled_at);
          const roundedMinutes = Math.round(scheduledTime.getMinutes() / 15) * 15;
          scheduledTime.setMinutes(roundedMinutes);
          scheduledTime.setSeconds(0);
          
          // Format the time slot key
          const timeSlotKey = scheduledTime.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          
          // Create the time slot if it doesn't exist
          if (!timeSlots[timeSlotKey]) {
            timeSlots[timeSlotKey] = [];
          }
          
          // Add the order to the time slot
          timeSlots[timeSlotKey].push(order);
        }
      });
      
      // Render time slots
      const sortedTimeSlots = Object.keys(timeSlots).sort((a, b) => {
        return new Date('1970/01/01 ' + a) - new Date('1970/01/01 ' + b);
      });
      
      sortedTimeSlots.forEach(slotKey => {
        const slotOrders = timeSlots[slotKey];
        
        // Create time slot container
        const timeSlotElement = document.createElement('div');
        timeSlotElement.className = 'time-slot';
        
        // Create time slot header
        const timeSlotHeader = document.createElement('div');
        timeSlotHeader.className = 'time-slot-header';
        timeSlotHeader.textContent = slotKey;
        timeSlotElement.appendChild(timeSlotHeader);
        
        // Create orders container for this time slot
        const slotOrdersContainer = document.createElement('div');
        slotOrdersContainer.className = 'slot-orders';
        
        // Add each order to the slot
        slotOrders.forEach(order => {
          const orderCard = createOrderCard(order);
          slotOrdersContainer.appendChild(orderCard);
        });
        
        timeSlotElement.appendChild(slotOrdersContainer);
        timeSlotsContainer.appendChild(timeSlotElement);
      });
      
      // Render cashier orders
      console.log(`Found ${cashierOrders.length} cashier orders`);
      
      if (cashierOrders.length === 0) {
        cashierOrdersContainer.innerHTML = '<div class="no-orders">No walk-in or unscheduled orders</div>';
      } else {
        // Create orders container for cashier orders
        const cashierOrdersElement = document.createElement('div');
        cashierOrdersElement.className = 'cashier-orders';
        
        // Add each cashier order
        cashierOrders.forEach(order => {
          const orderCard = createOrderCard(order);
          cashierOrdersElement.appendChild(orderCard);
        });
        
        cashierOrdersContainer.appendChild(cashierOrdersElement);
      }
    }
    
    // Format time for display
    function formatTime(date) {
      if (!date) return 'ASAP';
      
      return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }
    
    // Create compact order card with expand/collapse
    function createOrderCard(order) {
      const orderCard = document.createElement('div');
      orderCard.className = `order-card status-${order.status}`;
      orderCard.dataset.orderId = order.id;
      
      // Format the time
      const orderTime = order.scheduled_at ? new Date(order.scheduled_at) : null;
      const formattedTime = formatTime(orderTime);
      
      // Create order header
      const orderHeader = document.createElement('div');
      orderHeader.className = 'order-header';
      
      // Order ID
      const orderId = document.createElement('div');
      orderId.className = 'order-id';
      orderId.textContent = `Order #${order.id}`;
      orderHeader.appendChild(orderId);
      
      // Order status
      const orderStatus = document.createElement('div');
      orderStatus.className = `order-status status-${order.status}`;
      orderStatus.textContent = order.status;
      orderHeader.appendChild(orderStatus);
      
      orderCard.appendChild(orderHeader);
      
      // Order details
      const orderDetails = document.createElement('div');
      orderDetails.className = 'order-details';
      
      // Customer name
      const customerName = document.createElement('div');
      customerName.className = 'order-customer';
      customerName.textContent = order.customer;
      orderDetails.appendChild(customerName);
      
      // Order source
      const orderSource = document.createElement('div');
      orderSource.className = 'order-source';
      orderSource.textContent = `Source: ${order.source}`;
      orderDetails.appendChild(orderSource);
      
      // Order time
      const orderTimeElement = document.createElement('div');
      orderTimeElement.className = 'order-time';
      orderTimeElement.textContent = `Time: ${formattedTime}`;
      orderDetails.appendChild(orderTimeElement);
      
      orderCard.appendChild(orderDetails);
      
      // Order actions
      const orderActions = document.createElement('div');
      orderActions.className = 'order-actions';
      
      // Edit button
      const editButton = document.createElement('button');
      editButton.className = 'btn btn-primary';
      editButton.textContent = 'Edit';
      editButton.addEventListener('click', (e) => {
        e.stopPropagation();
        loadOrderForEdit(order.id);
      });
      orderActions.appendChild(editButton);
      
      // Complete button
      const completeButton = document.createElement('button');
      completeButton.className = 'btn btn-success';
      completeButton.textContent = 'Complete';
      
      // Hide complete button if order is already done
      if (order.status === 'done') {
        completeButton.style.display = 'none';
      } else {
        completeButton.addEventListener('click', async (e) => {
          e.stopPropagation();
          try {
            const updatedOrder = {
              id: order.id,
              status: 'done'
            };
            
            const response = await fetch(API_CONFIG.getUrl(`/orders/${order.id}`), {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(updatedOrder)
            });
            
            if (!response.ok) {
              throw new Error('Failed to update order status');
            }
            
            // Update the UI
            orderStatus.textContent = 'done';
            orderStatus.className = 'order-status status-done';
            orderCard.className = 'order-card status-done';
            completeButton.style.display = 'none';
            
            showNotification('Order marked as complete', 'success');
          } catch (error) {
            console.error('Error updating order status:', error);
            showNotification('Error: ' + error.message, 'error');
          }
        });
      }
      orderActions.appendChild(completeButton);
      
      orderCard.appendChild(orderActions);
      
      // Make the entire card clickable to view details
      orderCard.addEventListener('click', () => {
        loadOrderDetails(order.id);
      });
      
      return orderCard;
    }
    
    // Load order for editing
    async function loadOrderForEdit(orderId) {
      try {
        const response = await fetch(API_CONFIG.getUrl(`/orders/${orderId}`));
        if (!response.ok) {
          throw new Error('Failed to fetch order details');
        }
        
        const order = await response.json();
        
        // Set form to edit mode
        formTitle.textContent = `Edit Order #${order.order_number || 'N/A'}`;
        orderIdInput.value = order.id;
        document.getElementById('customer').value = order.customer || '';
        document.getElementById('source').value = order.source || 'walk-in';
        document.getElementById('status').value = order.status || 'pending';
        
        if (order.scheduled_at) {
          const scheduledDate = new Date(order.scheduled_at);
          document.getElementById('scheduled-time').value = formatDateTimeLocal(scheduledDate);
        } else {
          document.getElementById('scheduled-time').value = '';
        }
        
        // Clear existing items
        itemsList.innerHTML = '';
        
        // Add existing items
        if (order.items && order.items.length > 0) {
          order.items.forEach(item => addItemRow(item));
        }
        
        // Show the form container
        orderFormContainer.style.display = 'block';
        
        // Scroll to form
        document.getElementById('order-form').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        showNotification('Error loading order: ' + error.message, 'error');
      }
    }
    
    // Format date for datetime-local input
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // Reset form
    function resetForm() {
      formTitle.textContent = 'Create New Order';
      orderIdInput.value = '';
      document.getElementById('customer').value = '';
      document.getElementById('source').value = 'walk-in';
      document.getElementById('status').value = 'pending';
      document.getElementById('scheduled-time').value = '';
      itemsList.innerHTML = '';
    }
    
    // Cancel edit button
    cancelEditButton.addEventListener('click', function() {
      resetForm();
      orderFormContainer.style.display = 'none';
    });
    
    // Save order
    saveOrderButton.addEventListener('click', async function() {
      const orderId = orderIdInput.value;
      const customer = document.getElementById('customer').value;
      
      if (!customer) {
        showNotification('Customer name is required', 'error');
        return;
      }
      
      // Collect order data
      const orderData = {
        customer,
        source: document.getElementById('source').value,
        status: document.getElementById('status').value
      };
      
      const scheduledTime = document.getElementById('scheduled-time').value;
      if (scheduledTime) {
        orderData.scheduled_at = new Date(scheduledTime).toISOString();
      }
      
      // Collect items
      const itemRows = itemsList.querySelectorAll('.item-row');
      const items = [];
      
      itemRows.forEach(row => {
        const itemName = row.querySelector('.item-name').value;
        if (!itemName) return; // Skip items without names
        
        const item = {
          item_name: itemName,
          quantity: parseInt(row.querySelector('.item-quantity').value) || 1,
          station: row.querySelector('.station-select').value,
          preparation_time_minutes: parseInt(row.querySelector('.prep-time').value) || 15,
          item_status: row.querySelector('.item-status-select').value
        };
        
        // Include ID if editing existing item
        if (row.dataset.itemId) {
          item.id = row.dataset.itemId;
        }
        
        items.push(item);
      });
      
      if (items.length === 0) {
        showNotification('At least one item is required', 'error');
        return;
      }
      
      try {
        let response;
        let url = API_CONFIG.getUrl('/orders');
        let method = 'POST';
        
        // Update existing order
        if (orderId) {
          url = API_CONFIG.getUrl(`/orders/${orderId}`);
          method = 'PUT';
        }
        
        response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            order: orderData,
            items
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save order');
        }
        
        const result = await response.json();
        
        // Check for partial success (new items couldn't be created)
        if (response.status === 207 && result.message) {
          showNotification(result.message, 'warning');
        } else {
          showNotification(orderId ? 'Order updated successfully' : 'Order created successfully', 'success');
        }
        
        // Reset form and reload orders
        resetForm();
        orderFormContainer.style.display = 'none';
        loadAllOrders();
      } catch (error) {
        showNotification('Error: ' + error.message, 'error');
      }
    });
    
    // Notification system
    function showNotification(message, type) {
      // Remove any existing notifications
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      // Add to DOM
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }
    
    // Load order details for viewing
    async function loadOrderDetails(orderId) {
      try {
        // Show loading state
        const detailsContainer = document.getElementById('order-details-container');
        detailsContainer.innerHTML = '<div class="loading">Loading order details...</div>';
        
        // Show the details tab
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('details-tab').classList.add('active');
        document.getElementById('details-content').classList.add('active');
        
        // Fetch order details
        const response = await fetch(API_CONFIG.getUrl(`/orders/${orderId}`));
        
        if (!response.ok) {
          throw new Error('Failed to fetch order details');
        }
        
        const order = await response.json();
        
        // Format the time
        const orderTime = order.scheduled_at ? new Date(order.scheduled_at) : null;
        const formattedTime = formatTime(orderTime);
        
        // Create order details HTML
        let itemsHtml = '';
        if (order.items && order.items.length > 0) {
          itemsHtml = order.items.map(item => `
            <div class="detail-item">
              <div class="item-name">${item.item_name}</div>
              <div class="item-quantity">x${item.quantity}</div>
              <div class="item-station">${item.station}</div>
              <div class="item-status status-${item.item_status}">${item.item_status}</div>
            </div>
          `).join('');
        } else {
          itemsHtml = '<div class="no-items">No items in this order</div>';
        }
        
        detailsContainer.innerHTML = `
          <div class="order-detail-card">
            <div class="detail-header">
              <h2>Order #${order.id}</h2>
              <div class="order-status status-${order.status}">${order.status}</div>
            </div>
            
            <div class="detail-info">
              <div class="info-row">
                <div class="info-label">Customer:</div>
                <div class="info-value">${order.customer}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Source:</div>
                <div class="info-value">${order.source}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Time:</div>
                <div class="info-value">${formattedTime}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Created:</div>
                <div class="info-value">${new Date(order.created_at).toLocaleString()}</div>
              </div>
            </div>
            
            <div class="detail-items">
              <h3>Items</h3>
              <div class="items-list">
                ${itemsHtml}
              </div>
            </div>
            
            <div class="detail-actions">
              <button class="btn btn-primary" id="edit-order-btn">Edit Order</button>
              ${order.status !== 'done' ? `<button class="btn btn-success" id="complete-order-btn">Mark as Complete</button>` : ''}
              <button class="btn btn-danger" id="delete-order-btn">Delete Order</button>
            </div>
          </div>
        `;
        
        // Add event listeners to buttons
        document.getElementById('edit-order-btn').addEventListener('click', () => {
          loadOrderForEdit(order.id);
        });
        
        if (order.status !== 'done') {
          document.getElementById('complete-order-btn').addEventListener('click', async () => {
            try {
              const updatedOrder = {
                id: order.id,
                status: 'done'
              };
              
              const response = await fetch(API_CONFIG.getUrl(`/orders/${order.id}`), {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedOrder)
              });
              
              if (!response.ok) {
                throw new Error('Failed to update order status');
              }
              
              // Reload order details
              loadOrderDetails(order.id);
              
              // Reload orders list
              loadAllOrders();
              
              showNotification('Order marked as complete', 'success');
            } catch (error) {
              console.error('Error updating order status:', error);
              showNotification('Error: ' + error.message, 'error');
            }
          });
        }
        
        document.getElementById('delete-order-btn').addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
            try {
              const response = await fetch(API_CONFIG.getUrl(`/orders/${order.id}`), {
                method: 'DELETE'
              });
              
              if (!response.ok) {
                throw new Error('Failed to delete order');
              }
              
              // Go back to orders tab
              document.getElementById('orders-tab').click();
              
              // Reload orders list
              loadAllOrders();
              
              showNotification('Order deleted successfully', 'success');
            } catch (error) {
              console.error('Error deleting order:', error);
              showNotification('Error: ' + error.message, 'error');
            }
          }
        });
        
      } catch (error) {
        console.error('Error loading order details:', error);
        const detailsContainer = document.getElementById('order-details-container');
        detailsContainer.innerHTML = `<div class="error">Error loading order details: ${error.message}</div>`;
      }
    }
    
    // Initial load
    loadAllOrders();
    
    // Refresh orders every 15 seconds (for testing purposes, can be adjusted back to 60000 later)
    setInterval(loadAllOrders, 15000);
  </script>
</body>
</html> 

