<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Manager</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- API Config for environment-aware endpoints -->
  <script src="api-config.js"></script>
  <script src="supabase-client.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .nav-header {
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .manager {
      background-color: #673AB7;
    }

    .nav-items {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }

    .nav-tab {
      flex: 1;
      background-color: #f1f1f1;
      padding: 10px 15px;
      text-align: center;
      border-radius: 4px;
      margin: 0 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .nav-tab.active {
      background-color: #2196F3;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    #order-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    h1, h2, h3 {
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    .items-container {
      margin-top: 20px;
    }

    .item-row {
      display: grid;
      grid-template-columns: 3fr 1fr 1fr 1fr 1fr 80px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .item-header {
      font-weight: bold;
      padding: 8px 0;
      border-bottom: 2px solid #eee;
    }

    .btn-add-item {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }

    .btn-remove-item {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-save {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    
    .btn-cancel {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .btn-edit {
      background-color: #FF9800;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5px;
    }

    .time-slots-wrapper {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .time-slot {
      margin-bottom: 20px;
    }

    .time-slot-header {
      background-color: #673AB7;
      color: white;
      padding: 8px 15px;
      border-radius: 4px 4px 0 0;
      font-weight: bold;
      margin-bottom: 0;
    }

    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background-color: white;
      border-radius: 0 0 4px 4px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .order-card {
      border-left: 3px solid #2196F3;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .order-card:hover {
      background-color: #f0f0f0;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-summary {
      font-size: 14px;
      margin-top: 5px;
      color: #666;
    }

    .order-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0;
      margin-top: 0;
    }

    .order-card.expanded .order-details {
      max-height: 500px;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 1px solid #eee;
    }

    .order-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background-color: #FFC107;
      color: #333;
    }

    .status-in-progress {
      background-color: #2196F3;
      color: white;
    }

    .status-done {
      background-color: #4CAF50;
      color: white;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
      max-width: 300px;
    }

    .notification-success {
      background-color: #4CAF50;
    }

    .notification-error {
      background-color: #f44336;
    }

    .notification-warning {
      background-color: #FF9800;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    @keyframes fadeOut {
      from {opacity: 1;}
      to {opacity: 0;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="nav-header manager">
        <h1>Restaurant Manager</h1>
        <button id="create-order-btn" class="btn-save">Create New Order</button>
      </div>
      
      <div class="nav-items">
        <div class="nav-tab active" data-tab="time-slots">Time Slots</div>
        <div class="nav-tab" data-tab="cashier">Cashier Orders</div>
      </div>
    </header>
    
    <main>
      <div id="order-form-container" style="display: none;">
        <div id="order-form" class="order-form">
          <h2 id="form-title">Create New Order</h2>
          <input type="hidden" id="order-id">

          <div class="form-group">
            <label for="customer">Customer Name:</label>
            <input type="text" id="customer" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="source">Order Source:</label>
            <select id="source" class="form-control">
              <option value="walk-in">Walk-in</option>
              <option value="phone">Phone</option>
              <option value="online">Online</option>
            </select>
          </div>

          <div class="form-group">
            <label for="scheduled-time">Scheduled Time:</label>
            <input type="datetime-local" id="scheduled-time" class="form-control">
          </div>

          <div class="form-group">
            <label for="status">Status:</label>
            <select id="status" class="form-control">
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="items-container">
            <h3>Order Items</h3>
            
            <div class="item-row item-header">
              <div>Item Name</div>
              <div>Quantity</div>
              <div>Station</div>
              <div>Prep Time</div>
              <div>Status</div>
              <div>Action</div>
            </div>
            
            <div id="items-list">
              <!-- Items will be added here dynamically -->
            </div>
            
            <button id="add-item" class="btn-add-item">+ Add Item</button>
          </div>
          
          <div class="form-actions">
            <button id="save-order" class="btn-save">Save Order</button>
            <button id="cancel-edit" class="btn-cancel" style="margin-left: 10px;">Cancel</button>
          </div>
        </div>
      </div>
      
      <div class="tab-content active" id="time-slots-content">
        <h2>Orders by Time Slot</h2>
        <div id="time-slots-container" class="time-slots-wrapper">
          <!-- Time slots will be generated here -->
        </div>
      </div>
      
      <div class="tab-content" id="cashier-content">
        <h2>Cashier Orders</h2>
        <div id="cashier-orders-container" class="orders-list">
          <!-- Cashier orders will be displayed here -->
        </div>
      </div>
    </main>
  </div>
  
  <!-- Template for item row -->
  <template id="item-template">
    <div class="item-row" data-item-id="">
      <input type="text" class="form-control item-name" placeholder="Item name">
      <input type="number" class="form-control item-quantity" min="1" value="1">
      <select class="station-select">
        <option value="grill">Grill</option>
        <option value="kitchen">Kitchen</option>
        <option value="fries">Fries</option>
        <option value="assembly">Assembly</option>
      </select>
      <input type="number" class="form-control prep-time" min="0" value="15" placeholder="Minutes">
      <select class="item-status-select">
        <option value="pending">Pending</option>
        <option value="in_progress">In Progress</option>
        <option value="done">Done</option>
      </select>
      <button class="btn-remove-item">Remove</button>
    </div>
  </template>
  
  <script>
    // DOM Elements
    const orderForm = document.getElementById('order-form');
    const orderFormContainer = document.getElementById('order-form-container');
    const formTitle = document.getElementById('form-title');
    const orderIdInput = document.getElementById('order-id');
    const addItemButton = document.getElementById('add-item');
    const saveOrderButton = document.getElementById('save-order');
    const cancelEditButton = document.getElementById('cancel-edit');
    const createOrderBtn = document.getElementById('create-order-btn');
    const itemsList = document.getElementById('items-list');
    const timeSlotsContainer = document.getElementById('time-slots-container');
    const cashierOrdersContainer = document.getElementById('cashier-orders-container');
    const itemTemplate = document.getElementById('item-template');
    const navTabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Tab switching functionality
    navTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs
        navTabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Show corresponding content
        const tabId = this.getAttribute('data-tab');
        document.getElementById(`${tabId}-content`).classList.add('active');
      });
    });
    
    // Create Order button
    createOrderBtn.addEventListener('click', function() {
      resetForm();
      orderFormContainer.style.display = 'block';
    });
    
    // Add item functionality
    function addItemRow(item = {}) {
      const newItem = document.importNode(itemTemplate.content, true);
      const itemRow = newItem.querySelector('.item-row');
      
      // Set values if item is provided
      if (item.id) {
        itemRow.dataset.itemId = item.id;
      }
      
      if (item.item_name) {
        newItem.querySelector('.item-name').value = item.item_name;
      }
      
      if (item.quantity) {
        newItem.querySelector('.item-quantity').value = item.quantity;
      }
      
      if (item.station) {
        newItem.querySelector('.station-select').value = item.station;
      }
      
      if (item.preparation_time_minutes) {
        newItem.querySelector('.prep-time').value = item.preparation_time_minutes;
      }
      
      if (item.item_status) {
        newItem.querySelector('.item-status-select').value = item.item_status;
      }
      
      // Add remove button functionality
      newItem.querySelector('.btn-remove-item').addEventListener('click', function() {
        itemRow.remove();
      });
      
      itemsList.appendChild(newItem);
    }
    
    // Add item button click
    addItemButton.addEventListener('click', function() {
      addItemRow();
    });
    
    // Load orders
    async function loadAllOrders() {
      try {
        document.getElementById('orders-container').innerHTML = '<div class="loading">Loading orders...</div>';
        
        // Use API_CONFIG to get the appropriate URL for the environment
        const response = await fetch(API_CONFIG.getUrl('/orders'));
        
        if (!response.ok) {
          throw new Error('Failed to fetch orders');
        }
        
        const orders = await response.json();
        displayOrders(orders);
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('orders-container').innerHTML = `<div class="error">Error loading orders: ${error.message}</div>`;
      }
    }
    
    // Display orders in the UI
    function displayOrders(orders) {
      if (!orders || !Array.isArray(orders)) {
        console.error('Invalid orders data received:', orders);
        document.getElementById('orders-container').innerHTML = '<div class="error">Error: Invalid data format received from server</div>';
        return;
      }
      
      console.log('Displaying orders:', orders);
      
      // Reset containers
      document.getElementById('orders-container').innerHTML = '';
      
      // Re-create containers
      const ordersContainer = document.getElementById('orders-container');
      
      const timeSlotsSection = document.createElement('div');
      timeSlotsSection.className = 'time-slots-section';
      timeSlotsSection.innerHTML = '<h3>Scheduled Orders</h3>';
      
      const timeSlotsContainer = document.createElement('div');
      timeSlotsContainer.className = 'time-slots-container';
      timeSlotsSection.appendChild(timeSlotsContainer);
      
      const cashierSection = document.createElement('div');
      cashierSection.className = 'cashier-section';
      cashierSection.innerHTML = '<h3>Walk-in Orders</h3>';
      
      const cashierOrdersContainer = document.createElement('div');
      cashierOrdersContainer.className = 'cashier-orders-container';
      cashierSection.appendChild(cashierOrdersContainer);
      
      // Add sections to main container
      ordersContainer.appendChild(timeSlotsSection);
      ordersContainer.appendChild(cashierSection);
      
      // Organize and display orders
      organizeOrders(orders, timeSlotsContainer, cashierOrdersContainer);
    }
    
    // Organize orders into time slots and cashier orders
    function organizeOrders(orders, timeSlotsContainer, cashierOrdersContainer) {
      // Clear containers
      timeSlotsContainer.innerHTML = '';
      cashierOrdersContainer.innerHTML = '';
      
      if (!orders || orders.length === 0) {
        timeSlotsContainer.innerHTML = '<p>No orders found.</p>';
        cashierOrdersContainer.innerHTML = '<p>No cashier orders found.</p>';
        return;
      }
      
      // Group orders by time slots (10 min intervals)
      const timeSlots = {};
      const cashierOrders = [];
      
      orders.forEach(order => {
        // Handle cashier (walk-in) orders separately
        if (order.source === 'walk-in') {
          cashierOrders.push(order);
        }
        
        // Group other orders by scheduled time
        if (order.scheduled_at) {
          const orderDate = new Date(order.scheduled_at);
          // Round to nearest 10-minute slot
          const minutes = Math.floor(orderDate.getMinutes() / 10) * 10;
          orderDate.setMinutes(minutes, 0, 0);
          
          const slotKey = orderDate.toLocaleString();
          
          if (!timeSlots[slotKey]) {
            timeSlots[slotKey] = [];
          }
          
          timeSlots[slotKey].push(order);
        }
      });
      
      // Render time slots
      const sortedSlotKeys = Object.keys(timeSlots).sort((a, b) => new Date(a) - new Date(b));
      
      sortedSlotKeys.forEach(slotKey => {
        const slotOrders = timeSlots[slotKey];
        
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        
        const timeHeader = document.createElement('div');
        timeHeader.className = 'time-slot-header';
        timeHeader.textContent = slotKey;
        timeSlot.appendChild(timeHeader);
        
        const ordersList = document.createElement('div');
        ordersList.className = 'orders-list';
        
        slotOrders.forEach(order => {
          const orderCard = createOrderCard(order);
          ordersList.appendChild(orderCard);
        });
        
        timeSlot.appendChild(ordersList);
        timeSlotsContainer.appendChild(timeSlot);
      });
      
      // Render cashier orders
      cashierOrders.forEach(order => {
        const orderCard = createOrderCard(order);
        cashierOrdersContainer.appendChild(orderCard);
      });
      
      // Show message if no cashier orders
      if (cashierOrders.length === 0) {
        cashierOrdersContainer.innerHTML = '<p>No cashier orders found.</p>';
      }
    }
    
    // Create compact order card with expand/collapse
    function createOrderCard(order) {
      const orderCard = document.createElement('div');
      orderCard.className = 'order-card';
      orderCard.dataset.orderId = order.id;
      
      const statusClass = `status-${order.status.replace('_', '-')}`;
      
      // Create item summary text
      let itemSummary = '';
      if (order.items && order.items.length > 0) {
        itemSummary = order.items.map(item => `${item.quantity}x ${item.item_name}`).join(', ');
      } else {
        itemSummary = 'No items';
      }
      
      // Create compact order summary
      orderCard.innerHTML = `
        <div class="order-header">
          <div><strong>#${order.order_number || 'N/A'}</strong> - ${order.customer}</div>
          <span class="order-status ${statusClass}">${order.status}</span>
        </div>
        <div class="order-summary">${itemSummary}</div>
        <div class="order-details">
          <p>Source: ${order.source}</p>
          <p>Time: ${order.scheduled_at ? new Date(order.scheduled_at).toLocaleString() : new Date(order.order_time).toLocaleString()}</p>
          <button class="btn-edit" data-order-id="${order.id}">Edit Order</button>
        </div>
      `;
      
      // Toggle expand/collapse on click
      orderCard.addEventListener('click', function(e) {
        // Don't expand if clicking edit button
        if (e.target.classList.contains('btn-edit')) {
          e.stopPropagation();
          loadOrderForEdit(order.id);
          return;
        }
        
        this.classList.toggle('expanded');
      });
      
      // Add edit button functionality
      orderCard.querySelector('.btn-edit').addEventListener('click', () => {
        loadOrderForEdit(order.id);
      });
      
      return orderCard;
    }
    
    // Load order for editing
    async function loadOrderForEdit(orderId) {
      try {
        const response = await fetch(API_CONFIG.getUrl(`/orders/${orderId}`));
        if (!response.ok) {
          throw new Error('Failed to fetch order details');
        }
        
        const order = await response.json();
        
        // Set form to edit mode
        formTitle.textContent = `Edit Order #${order.order_number || 'N/A'}`;
        orderIdInput.value = order.id;
        document.getElementById('customer').value = order.customer || '';
        document.getElementById('source').value = order.source || 'walk-in';
        document.getElementById('status').value = order.status || 'pending';
        
        if (order.scheduled_at) {
          const scheduledDate = new Date(order.scheduled_at);
          document.getElementById('scheduled-time').value = formatDateTimeLocal(scheduledDate);
        } else {
          document.getElementById('scheduled-time').value = '';
        }
        
        // Clear existing items
        itemsList.innerHTML = '';
        
        // Add existing items
        if (order.items && order.items.length > 0) {
          order.items.forEach(item => addItemRow(item));
        }
        
        // Show the form container
        orderFormContainer.style.display = 'block';
        
        // Scroll to form
        document.getElementById('order-form').scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        showNotification('Error loading order: ' + error.message, 'error');
      }
    }
    
    // Format date for datetime-local input
    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // Reset form
    function resetForm() {
      formTitle.textContent = 'Create New Order';
      orderIdInput.value = '';
      document.getElementById('customer').value = '';
      document.getElementById('source').value = 'walk-in';
      document.getElementById('status').value = 'pending';
      document.getElementById('scheduled-time').value = '';
      itemsList.innerHTML = '';
    }
    
    // Cancel edit button
    cancelEditButton.addEventListener('click', function() {
      resetForm();
      orderFormContainer.style.display = 'none';
    });
    
    // Save order
    saveOrderButton.addEventListener('click', async function() {
      const orderId = orderIdInput.value;
      const customer = document.getElementById('customer').value;
      
      if (!customer) {
        showNotification('Customer name is required', 'error');
        return;
      }
      
      // Collect order data
      const orderData = {
        customer,
        source: document.getElementById('source').value,
        status: document.getElementById('status').value
      };
      
      const scheduledTime = document.getElementById('scheduled-time').value;
      if (scheduledTime) {
        orderData.scheduled_at = new Date(scheduledTime).toISOString();
      }
      
      // Collect items
      const itemRows = itemsList.querySelectorAll('.item-row');
      const items = [];
      
      itemRows.forEach(row => {
        const itemName = row.querySelector('.item-name').value;
        if (!itemName) return; // Skip items without names
        
        const item = {
          item_name: itemName,
          quantity: parseInt(row.querySelector('.item-quantity').value) || 1,
          station: row.querySelector('.station-select').value,
          preparation_time_minutes: parseInt(row.querySelector('.prep-time').value) || 15,
          item_status: row.querySelector('.item-status-select').value
        };
        
        // Include ID if editing existing item
        if (row.dataset.itemId) {
          item.id = row.dataset.itemId;
        }
        
        items.push(item);
      });
      
      if (items.length === 0) {
        showNotification('At least one item is required', 'error');
        return;
      }
      
      try {
        let response;
        let url = 'http://localhost:3000/orders';
        let method = 'POST';
        
        // Update existing order
        if (orderId) {
          url = `http://localhost:3000/orders/${orderId}`;
          method = 'PUT';
        }
        
        response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            order: orderData,
            items
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save order');
        }
        
        const result = await response.json();
        
        // Check for partial success (new items couldn't be created)
        if (response.status === 207 && result.message) {
          showNotification(result.message, 'warning');
        } else {
          showNotification(orderId ? 'Order updated successfully' : 'Order created successfully', 'success');
        }
        
        // Reset form and reload orders
        resetForm();
        orderFormContainer.style.display = 'none';
        loadAllOrders();
      } catch (error) {
        showNotification('Error: ' + error.message, 'error');
      }
    });
    
    // Notification system
    function showNotification(message, type) {
      // Remove any existing notifications
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      // Add to DOM
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }
    
    // Initial load
    loadAllOrders();
    
    // Refresh orders every minute
    setInterval(loadAllOrders, 60000);
  </script>
</body>
</html> 

